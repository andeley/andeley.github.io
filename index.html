<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga"></script>
    <script src="https://cdn.rawgit.com/idevelop/camera.js/master/camera.min.js"></script>
</head>
<body>
    <button onclick="iniciarEscaneo()">Abrir Cámara y Escanear</button>

    <script>
        let currentStream; // Almacena la referencia al stream actual

        async function iniciarEscaneo() {
            try {
                if (currentStream) {
                    // Si hay un stream actual, detener y cerrar antes de abrir uno nuevo
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const selectedCamera = await Camera.getCamera();
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: selectedCamera.id,
                    }
                });

                const video = document.createElement('video');
                document.body.appendChild(video);

                video.srcObject = stream;
                await video.play();

                const scannerQR = new Instascan.Scanner({ video: video });
                scannerQR.addListener('scan', function (content) {
                    mostrarTextoEnTitulo(content);
                    scannerQR.stop();
                    cerrarCamara(video, stream); // Llama a la función para cerrar la cámara
                });

                const scannerBarcode = Quagga;
                scannerBarcode.onDetected(function (result) {
                    mostrarTextoEnTitulo(result.codeResult.code);
                    scannerBarcode.stop();
                    cerrarCamara(video, stream);
                });

                scannerQR.start();

                setTimeout(() => {
                    scannerQR.stop();
                    scannerBarcode.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: video
                        },
                        decoder: {
                            readers: ["ean_reader", "upc_reader"]
                        }
                    });
                    scannerBarcode.start();
                }, 5000);

            } catch (error) {
                console.error('Error al iniciar la cámara:', error);
            }
        }

        function mostrarTextoEnTitulo(texto) {
            document.title = texto;
        }

        function cerrarCamara(video, stream) {
            // Detener el video y liberar los recursos
            video.srcObject = null;
            video.pause();
            document.body.removeChild(video);
            
            // Detener y cerrar el stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }
    </script>
</body>
</html>

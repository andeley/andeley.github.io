<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga"></script>
</head>
<body>
    <button onclick="solicitarCamaras()">Seleccionar Cámara y Escanear</button>

    <script>
        let currentStream;

        async function solicitarCamaras() {
            try {
                if (currentStream) {
                    // Si hay un stream actual, detener y cerrar antes de abrir uno nuevo
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const cameras = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = cameras.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    console.error('No se encontraron cámaras disponibles.');
                    return;
                }

                const selectedCamera = await seleccionarCamaras(videoDevices);

                if (!selectedCamera) {
                    console.error('No se seleccionó ninguna cámara.');
                    return;
                }

                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: selectedCamera.deviceId,
                    }
                });

                abrirCamara(currentStream);

            } catch (error) {
                console.error('Error al iniciar la cámara:', error);
            }
        }

        async function seleccionarCamaras(cameras) {
            return new Promise(resolve => {
                const options = cameras.map((camera, index) => ({
                    label: `Cámara ${index + 1}`,
                    value: camera.deviceId,
                }));

                const selectedCamera = window.prompt('Seleccione una cámara:\n\n' + options.map(opt => `${opt.label}: ${opt.value}`).join('\n'));
                
                if (selectedCamera) {
                    const camera = cameras.find(cam => cam.deviceId === selectedCamera);
                    resolve(camera);
                } else {
                    resolve(null);
                }
            });
        }

        async function abrirCamara(stream) {
            const video = document.createElement('video');
            document.body.appendChild(video);

            video.srcObject = stream;
            await video.play();

            const scannerQR = new Instascan.Scanner({ video: video });
            scannerQR.addListener('scan', function (content) {
                mostrarTextoEnTitulo(content);
            });

            const scannerBarcode = Quagga;
            scannerBarcode.onDetected(function (result) {
                mostrarTextoEnTitulo(result.codeResult.code);
            });

            scannerQR.start();

            setTimeout(() => {
                scannerQR.stop();
                scannerBarcode.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video
                    },
                    decoder: {
                        readers: ["ean_reader", "upc_reader"]
                    }
                });
                scannerBarcode.start();
            }, 5000);
        }

        function mostrarTextoEnTitulo(texto) {
            document.title = texto;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga"></script>
</head>
<body>
    <button onclick="iniciarEscaneo()">Abrir Cámara y Escanear</button>

    <script>
        async function iniciarEscaneo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Utiliza la cámara trasera
                    }
                });

                const video = document.createElement('video');
                document.body.appendChild(video);

                video.srcObject = stream;
                await video.play();

                const scannerQR = new Instascan.Scanner({ video: video });
                scannerQR.addListener('scan', function (content) {
                    alert('Código QR detectado: ' + content);
                    scannerQR.stop();
                    video.srcObject.getTracks().forEach(track => track.stop());
                    document.body.removeChild(video);
                });

                const scannerBarcode = Quagga;
                scannerBarcode.onDetected(function (result) {
                    alert('Código de barras detectado: ' + result.codeResult.code);
                    scannerBarcode.stop();
                    video.srcObject.getTracks().forEach(track => track.stop());
                    document.body.removeChild(video);
                });

                // Iniciar con el escáner QR por defecto
                scannerQR.start();

                // Cambiar al escáner de código de barras si no se detecta un código QR en unos segundos
                setTimeout(() => {
                    scannerQR.stop();
                    scannerBarcode.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: video
                        },
                        decoder: {
                            readers: ["ean_reader", "upc_reader"]
                        }
                    });
                    scannerBarcode.start();
                }, 5000);

            } catch (error) {
                console.error('Error al iniciar la cámara:', error);
            }
        }
    </script>
</body>
</html>
